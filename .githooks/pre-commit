#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Clean build to ensure reproducibility"

# Reset build artifacts and deps
rm -rf node_modules .next

# Fresh install
npm ci

# Generate Prisma client (types + engines)
npx prisma generate

# Quality gates
npm run lint -- --max-warnings=0
npm run type-check
npm test -- --runInBand

# Build to verify (cache fonts offline, skip duplicate TS check)
NODE_OPTIONS="${NODE_OPTIONS:-"--max-old-space-size=2048"}" NEXT_FONT_MANUAL_DOWNLOAD=1 NEXT_TYPESCRIPT_IGNORE_BUILD_ERRORS=1 npm run build
